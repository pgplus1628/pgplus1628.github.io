<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Implementing Event Polling in Multi-Thread Environment with eventfd and epoll - PG's Thoughts</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="http://zorksylar.github.io/epoll-eventfd.html">

        <meta name="author" content="pgplus1628" />
        <meta name="keywords" content="[eventfd,parallel]" />

        <meta property="og:site_name" content="PG's Thoughts" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Implementing Event Polling in Multi-Thread Environment with eventfd and epoll"/>
        <meta property="og:url" content="http://zorksylar.github.io/epoll-eventfd.html"/>
        <meta property="og:description" content=""/>
        <meta property="article:published_time" content="2016-02-17" />
            <meta property="article:section" content="Blog" />
            <meta property="article:tag" content="[eventfd" />
            <meta property="article:tag" content="parallel]" />
            <meta property="article:author" content="pgplus1628" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://zorksylar.github.io/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="http://zorksylar.github.io/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://zorksylar.github.io/theme/css/pygments/manni.css" rel="stylesheet">
    <link rel="stylesheet" href="http://zorksylar.github.io/theme/css/style.css" type="text/css"/>

        <link href="http://zorksylar.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="PG's Thoughts ATOM Feed"/>



        <link href="http://zorksylar.github.io/feeds/blog.atom.xml" type="application/atom+xml" rel="alternate"
              title="PG's Thoughts Blog ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://zorksylar.github.io/" class="navbar-brand">
PG's Thoughts            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="http://zorksylar.github.io/">
                             Home
                          </a></li>
                        <li class="active">
                            <a href="http://zorksylar.github.io/category/blog.html">Blog</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="http://zorksylar.github.io/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-lg-12">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://zorksylar.github.io/epoll-eventfd.html"
                       rel="bookmark"
                       title="Permalink to Implementing Event Polling in Multi-Thread Environment with eventfd and epoll">
                        Implementing Event Polling in Multi-Thread Environment with eventfd and epoll
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2016-02-17T00:00:00+08:00"> Wed 17 February 2016</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="http://zorksylar.github.io/tag/eventfd.html">[eventfd</a>
        /
	<a href="http://zorksylar.github.io/tag/parallel.html">parallel]</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <h3>Poll/Notify Thread Synchronization Model in Multi-Thread Environment</h3>
<p>In most cases, we need to implement thread synchronization mechanism in the following manner: There are <em>W</em> <strong>Workers</strong>, and each worker communicates with each other through message passing. There is a <strong>Coordinator</strong> in each <strong>Worker</strong>, which is in charge of message sending and dispatching. Specifically, <strong>Sender</strong> and <strong>Receiver</strong> in Coordinator are for message sending and receiving. When one message arrived, Receiver should trigger an event according to the content of this message, and pass this event to <strong>Worker</strong> to do some user defined event handling.</p>
<p>Each Receiver maintains a <strong>channel</strong>(message buffer) for each Sender. There are <em>W</em> Workers, and there should be <em>W</em> channels for each Receiver. In the Receiver side, a listening-thread is needed to poll on these channels. Mostly, we do not want to waste CPU cycles on the listening-thread. We need a <strong>Poll/Notify</strong> mechanism to wake up the listening thread in Receiver when a channel is ready to read. I.E, when there is no channel available, the listening-thread should be blocked.</p>
<p>This model is useful in many cases, such as user-space network protocol implementation, and message passing between NUMA nodes(like this paper :<em>GraM: Scaling Graph Computation to the Trillions</em> does).</p>
<h3>conditional variable V.S. eventfd V.S. sockets</h3>
<p><code>pthread</code> provides <code>conditional wait</code> mechanism. Thread A wait for some event, and thread B can notify the threads that waiting on the event. This is the <strong>Wait/Notify</strong> thread synchronization. One thread wait and the other thread notify. The limitation of <code>conditional wait</code> is one thread can not wait on multiple condition variables.</p>
<p><code>eventfd</code> is introduced in Linux kernel after version 2.6.22.</p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;sys/eventfd.h&gt;</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">eventfd</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">initval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
</pre></div>


<blockquote>
<p>eventfd() creates an "eventfd object" that can be used as an event wait/notify mechanism by user-space applications, and by the kernel to notify user-space applications of events.  The object contains an unsigned 64-bit integer (uint64_t) counter that is maintained by the kernel. This counter is initialized with the value specified in the argument initval.</p>
</blockquote>
<p><code>eventfd</code> will create an file descriptor for event notification. The file descriptor can be used in <code>epoll/read/write</code> calls.</p>
<p>More information can be found in the <a href="http://man7.org/linux/man-pages/man2/eventfd.2.html">man page</a>.</p>
<p><code>Socket</code> is used for communication in distributed environment, which would bring the overhead of network communication stack in our case.</p>
<h3>Poll/Notify Implementation with eventfd and epoll</h3>
<p>The Poll/Notify mechanism can be implemented with eventfd and epoll. For the Receiver, it only needs to create an eventfd for each channel, and add them to  epoll file descriptor. The listening thread <code>epoll_wait</code> on the epoll file descriptor.</p>
<p>These codes can be found in <a href="https://github.com/zorksylar/ZLab/tree/master/eventfd">Github</a></p>
<p>The Coordinator Implmentation :</p>
<div class="highlight"><pre><span></span><span class="c1">//</span>
<span class="c1">// Created by zorksylar on 2/16/16.</span>
<span class="c1">//</span>

<span class="cp">#pragma once</span>

<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/time.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/eventfd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/epoll.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;glog/logging.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>


<span class="cp">#define EPOLL_WAIT_TIMEOUT (1000) </span><span class="c1">// 1.0 second</span>

<span class="k">class</span> <span class="nc">Receiver</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">RXArgs</span> <span class="p">{</span>
    <span class="n">Receiver</span> <span class="o">*</span> <span class="n">rx</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">class</span> <span class="nc">Receiver</span> <span class="p">{</span>
<span class="k">private</span> <span class="o">:</span>
    <span class="kt">int</span> <span class="n">kclient_</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">id_</span><span class="p">;</span>

<span class="k">public</span> <span class="o">:</span>
    <span class="kt">int</span> <span class="o">*</span> <span class="n">chan_fds</span><span class="p">;</span> <span class="c1">// event fds of this channel</span>
    <span class="n">pthread_t</span> <span class="n">listener</span><span class="p">;</span>

    <span class="n">Receiver</span><span class="p">(</span><span class="kt">int</span> <span class="n">kclients</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="o">:</span> <span class="n">kclient_</span><span class="p">(</span><span class="n">kclients</span><span class="p">),</span> <span class="n">id_</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">chan_fds</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span> <span class="p">[</span><span class="n">kclient_</span><span class="p">];</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">kclient_</span><span class="p">;</span><span class="n">i</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">chan_fds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">eventfd</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">EFD_NONBLOCK</span><span class="p">);</span>
            <span class="n">CHECK_NE</span><span class="p">(</span><span class="n">chan_fds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; Create eventfd for channel &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; failed.&quot;</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// TODO</span>
    <span class="kt">void</span> <span class="n">register_read_handler</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>

    <span class="kt">void</span> <span class="n">listen</span><span class="p">()</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

        <span class="c1">// create epoll event</span>
        <span class="k">struct</span> <span class="n">epoll_event</span> <span class="n">events</span><span class="p">[</span><span class="n">kclient_</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">ep_fd</span> <span class="o">=</span> <span class="n">epoll_create</span><span class="p">(</span><span class="n">kclient_</span><span class="p">);</span>
        <span class="n">CHECK_GE</span><span class="p">(</span><span class="n">ep_fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;RX::epoll_create failed.&quot;</span><span class="p">;</span>

        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">kclient_</span><span class="p">;</span><span class="n">i</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">struct</span> <span class="n">epoll_event</span> <span class="n">read_event</span><span class="p">;</span>
            <span class="kt">int</span> <span class="n">efd</span> <span class="o">=</span> <span class="n">chan_fds</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="n">read_event</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">EPOLLHUP</span> <span class="o">|</span> <span class="n">EPOLLERR</span> <span class="o">|</span> <span class="n">EPOLLIN</span> <span class="o">|</span> <span class="n">EPOLLET</span><span class="p">;</span>
            <span class="n">read_event</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">u32</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// store index</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">epoll_ctl</span><span class="p">(</span><span class="n">ep_fd</span><span class="p">,</span> <span class="n">EPOLL_CTL_ADD</span><span class="p">,</span> <span class="n">efd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">read_event</span><span class="p">);</span>
            <span class="n">CHECK_GE</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;RX &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">id_</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; ::epoll_ctl failed.&quot;</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;RX &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">id_</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; ::begin listening.&quot;</span><span class="p">;</span>
        <span class="c1">// while loop</span>
        <span class="kt">uint64_t</span> <span class="n">val</span><span class="p">;</span>
        <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">bool</span> <span class="n">ok</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="kt">int</span> <span class="n">nfds</span> <span class="o">=</span> <span class="n">epoll_wait</span><span class="p">(</span><span class="n">ep_fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">kclient_</span><span class="p">,</span> <span class="n">EPOLL_WAIT_TIMEOUT</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">nfds</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// handle each ready fd.</span>
                <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">nfds</span><span class="p">;</span><span class="n">i</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kt">int</span> <span class="n">cid</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">u32</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLHUP</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;RX &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">id_</span><span class="o">&lt;&lt;</span> <span class="s">&quot; ::epoll eventfd has epoll hup for &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">cid</span><span class="p">;</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLERR</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;RX &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">id_</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; ::epoll eventfd has epoll error for &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">cid</span><span class="p">;</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLIN</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kt">int</span> <span class="n">event_fd</span> <span class="o">=</span> <span class="n">chan_fds</span><span class="p">[</span><span class="n">cid</span><span class="p">];</span>
                        <span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">event_fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
                        <span class="n">CHECK_GE</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;RX&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">id_</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; ::read event_fd failed.&quot;</span><span class="p">;</span>
                        <span class="c1">// TODO read handler</span>
                        <span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;RX&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">id_</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; ::read from &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">cid</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; val &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; with size &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">ret</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; bytes.&quot;</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span> <span class="k">break</span><span class="p">;</span> <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span> <span class="k">break</span><span class="p">;</span> <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nfds</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;RX &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">id_</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; ::epoll wait time out.&quot;</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;RX &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">id_</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; ::epoll wait error.&quot;</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;RX &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">id_</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; ::exit listen.&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">listen_fn</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">args_</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="n">RXArgs</span> <span class="o">*</span> <span class="n">args</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">struct</span> <span class="n">RXArgs</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">args_</span><span class="p">);</span>
        <span class="n">Receiver</span> <span class="o">*</span> <span class="n">rx</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">;</span>
        <span class="n">rx</span><span class="o">-&gt;</span><span class="n">listen</span><span class="p">();</span>
        <span class="n">free</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
        <span class="n">pthread_exit</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="p">}</span>


    <span class="kt">void</span> <span class="n">start_listener</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="n">RXArgs</span> <span class="o">*</span> <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">RXArgs</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">RXArgs</span><span class="p">));</span>
        <span class="n">args</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">listener</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">Receiver</span><span class="o">::</span><span class="n">listen_fn</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">args</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">get_id</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">id_</span><span class="p">;</span> <span class="p">}</span>

    <span class="o">~</span><span class="n">Receiver</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// join listener</span>
        <span class="n">pthread_join</span><span class="p">(</span><span class="n">listener</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="c1">// close fds</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">kclient_</span><span class="p">;</span> <span class="n">i</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">chan_fds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="n">close</span><span class="p">(</span><span class="n">chan_fds</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span> <span class="n">chan_fds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;}</span>
        <span class="p">}</span>
        <span class="c1">// free</span>
        <span class="k">delete</span> <span class="n">chan_fds</span><span class="p">;</span>
    <span class="p">}</span>


<span class="p">};</span>



<span class="k">class</span> <span class="nc">Sender</span> <span class="p">{</span>
<span class="k">private</span> <span class="o">:</span>
    <span class="kt">int</span> <span class="n">kserver_</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">id_</span><span class="p">;</span>

<span class="k">public</span> <span class="o">:</span>
    <span class="kt">int</span> <span class="o">*</span> <span class="n">chan_fds</span><span class="p">;</span> <span class="c1">// channel eventfds, get from Receiver</span>

    <span class="n">Sender</span><span class="p">(</span><span class="kt">int</span> <span class="n">kserver</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">Receiver</span> <span class="o">**</span> <span class="n">servers</span><span class="p">)</span> <span class="o">:</span> <span class="n">kserver_</span><span class="p">(</span><span class="n">kserver</span><span class="p">),</span> <span class="n">id_</span><span class="p">(</span><span class="n">id</span><span class="p">){</span>
        <span class="n">chan_fds</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span> <span class="p">[</span><span class="n">kserver_</span><span class="p">];</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">kserver</span><span class="p">;</span><span class="n">i</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">chan_fds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">servers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">chan_fds</span><span class="p">[</span><span class="n">id_</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="n">signal</span><span class="p">(</span><span class="kt">int</span> <span class="n">serv_id</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">ssize_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">chan_fds</span><span class="p">[</span><span class="n">serv_id</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">==</span> <span class="n">EAGAIN</span><span class="p">);</span>
        <span class="n">CHECK_GE</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;TX &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">id_</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; -&gt; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">serv_id</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; write fd error : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">get_id</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">id_</span><span class="p">;</span> <span class="p">}</span>

<span class="p">};</span>
</pre></div>


<p>Main.cpp</p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;coordinator.hpp&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;glog/logging.h&gt;</span><span class="cp"></span>

<span class="cp">#define NNODE (8)</span>

<span class="k">struct</span> <span class="n">TXArgs</span> <span class="p">{</span>
    <span class="n">Sender</span> <span class="o">*</span> <span class="n">tx</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="o">*</span> <span class="nf">tx_fn</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">args_</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">TXArgs</span> <span class="o">*</span> <span class="n">args</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">struct</span> <span class="n">TXArgs</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">args_</span><span class="p">);</span>
    <span class="n">Sender</span> <span class="o">*</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">times</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">times</span><span class="p">;</span><span class="n">i</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">uint64_t</span> <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">get_id</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">rid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rid</span> <span class="o">&lt;</span> <span class="n">NNODE</span><span class="p">;</span> <span class="n">rid</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">tx</span><span class="o">-&gt;</span><span class="n">signal</span><span class="p">(</span><span class="n">rid</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
            <span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">get_id</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; -&gt; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">rid</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; val &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">val</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">Receiver</span> <span class="o">*</span> <span class="n">rxs</span><span class="p">[</span><span class="n">NNODE</span><span class="p">];</span>
    <span class="n">Sender</span> <span class="o">*</span><span class="n">txs</span><span class="p">[</span><span class="n">NNODE</span><span class="p">];</span>

    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">NNODE</span><span class="p">;</span> <span class="n">i</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">rxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Receiver</span><span class="p">(</span><span class="n">NNODE</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">NNODE</span><span class="p">;</span><span class="n">i</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">txs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Sender</span><span class="p">(</span><span class="n">NNODE</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rxs</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// start listeners</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">NNODE</span><span class="p">;</span><span class="n">i</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">rxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start_listener</span><span class="p">();</span>
    <span class="p">}</span>


    <span class="c1">// start senders</span>
    <span class="n">pthread_t</span> <span class="n">senders</span><span class="p">[</span><span class="n">NNODE</span><span class="p">];</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">NNODE</span><span class="p">;</span><span class="n">i</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="n">TXArgs</span> <span class="o">*</span> <span class="n">sarg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">TXArgs</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">TXArgs</span><span class="p">));</span>
        <span class="n">sarg</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="n">txs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">senders</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">tx_fn</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="n">sarg</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// join threads</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">NNODE</span><span class="p">;</span><span class="n">i</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pthread_join</span><span class="p">(</span><span class="n">senders</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">NNODE</span><span class="p">;</span><span class="n">i</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">delete</span> <span class="n">rxs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="n">rxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'zorkblog'; // required: replace example with your forum shortname

                    var disqus_identifier = 'epoll-eventfd';
                var disqus_url = 'http://zorksylar.github.io/epoll-eventfd.html';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <!--
         -->
         <div class="col-xs-10">&copy; 2016 pgplus1628
            <!--
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>
            -->         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://zorksylar.github.io/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://zorksylar.github.io/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://zorksylar.github.io/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'zorkblog'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-40862585-2']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->

</body>
</html>